<template>
  <div id="container-wrap">
      <div id="container-wrap" class="div-cont">
          <div id="contents">
            <div :key="i" v-for="(place, i) in recommendListDetailPlace">
              <div id="subleft-cont">
                  <div id="div_profile">
                          <div class="cont-main"  >
                              <div class="reply-img-wrap">
                                  <img :src="place.recommendPlaceImgPath || 'default-image-url'" alt="Detail Image" class="cont-main-img">
                              </div>
                              <div class="detail-content">
                                  <div class="detail-info-wrap">
                                      <div class="detail-info-header">
                                        <div>
                                          <h2 class="detail-title">{{ place.recommendPlaceTitle }}</h2>
                                        </div>
                                        <!-- ÏòÅÏóÖÏÉÅÌÉú -->
                                        <div>
                                          <span class="status" :class="getStatusClass(place.recommendPlaceClosetime)">
                                              {{ getStatusMessage(place.recommendPlaceClosetime) }}
                                          </span>
                                        </div>
                                      </div>
                                      <div class="detail-subtitle">{{ place.recommendPlaceIntroduction }}</div>
                                      <!-- ÌèâÍ∑† ÌèâÏ†ê (Ïà´ÏûêÏôÄ Î≥ÑÎ°ú ÌëúÏãú) -->
                                      <div class="detail-rating">
                                        <span v-for="star in 5" :key="star" class="star"
                                            :class="{ filled: star <= Math.round(replyPlaceStar) }">‚òÖ</span>
                                        <span class="rating-txt">{{ replyPlaceStar }}</span>
                                      </div>
                                  </div>
                                  <div class="detail-option-wrap">
                                    <div class="detail-option">
                                      <span class="detail-option-icon"><font-awesome-icon :icon="['fas', 'location-dot']" /></span>
                                      <span>{{ place.recommendPlaceAddress }}</span>
                                    </div>
                                    <div class="detail-option">
                                      <span class="detail-option-icon"><font-awesome-icon :icon="['fas', 'square-phone']" /></span>
                                      <span>{{ place.recommendPlacePhoneNo }}</span>
                                    </div>
                                    <div class="detail-option">
                                      <span class="detail-option-icon"><font-awesome-icon :icon="['fas', 'tag']" /></span>
                                      <span>{{ place.recommendPlaceTag }}</span>
                                    </div>
                                  </div>
                              </div>
                          </div>
                          <div class="cont-sub">
                              <div class="cont-time">
                                  <div>
                                    <h4 class="detail-title">ÏòÅÏóÖÏãúÍ∞Ñ</h4>
                                    <ul>
                                        <li v-for="day in ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº']" :key="day">
                                          <div class="cont-time-wrap">
                                          <div>
                                            {{ day }}ÏöîÏùº: 
                                          </div>
                                          <div>
                                            <span>{{ place.recommendPlaceOpentime }}</span>
                                            - 
                                            <span>{{ place.recommendPlaceClosetime }}</span>
                                        </div>
                                        </div>
                                        </li>
                                    </ul>
                                  </div>
                                  <div class="detail-tags-wrap">
                                    <h4 class="detail-title">{{ place.recommendPlaceTitle }} ÌÉúÍ∑∏</h4>
                                    <div>
                                      <button
                                        type="button"
                                        class="btn btn-outline-primary detail-tags"
                                        v-for="tag in parseTags(place.recommendPlaceAllTag)"
                                        :key="tag"
                                      >
                                        {{ tag }}
                                      </button>
                                    </div>
                                  </div>
                            </div><!-- cont-time -->
                        <div class="cont-reply">
                          <div class="cont-reply-info">
                            <h4 class="detail-title">Î∞©Î¨∏Ïûê ÌèâÍ∞Ä</h4>
                            <div class="detail-info-header cont-reply-line" >
                              <p class="detail-reply-txt">üòé Ïù¥Îü∞ Ï†êÏù¥ Ï¢ãÏïòÏñ¥Ïöî</p>
                              <div>
                              <button type="button" class="btn btn-primary btn-reply" @click="createModal(recommendPlaceId)" style="cursor: pointer">
                                <span><font-awesome-icon :icon="['far', 'pen-to-square']" /></span>ÌèâÏ†êÏì∞Í∏∞</button>
                              </div>
                            </div>
                          </div>
                          <div>
                            <div class="cont-chart">
                                <!-- PlaceChart Ïª¥Ìè¨ÎÑåÌä∏Ïóê recommendPlaceIdÎ•º Ï†ÑÎã¨Ìï©ÎãàÎã§ -->
                                <PlaceChart :recommendPlaceId="place.recommendPlaceId" />
                            </div>
                          </div>
                          <div class="cont-reply-caution">
                            <span class="cont-reply-caution-massage">üòä Ïù¥ {{place.recommendPlaceCategory }}Îäî Ïó¨Îü¨ Î∞©Î¨∏Í∞ùÎì§Ïùò ÏÉùÏÉùÌïú ÌèâÍ∞ÄÎ•º ÌÜµÌï¥ Ïã†Î¢∞Î•º ÏåìÏïòÏñ¥Ïöî. Ïó¨Îü¨Î∂ÑÎèÑ ÎßàÏùå Ìé∏Ìûà Ï¶êÍ≤®Î≥¥ÏÑ∏Ïöî!</span>
                            <p class="cont-reply-caution-massage">‚ÄªÌôçÎ≥¥ Î∞è ÎπÑÎ∞© Îì± Î∂ÄÏ†ÅÏ†àÌïú ÌèâÍ∞ÄÎäî  ÌèâÏ†ê ÏÇ∞Ï†ïÏóêÏÑú Ï†úÏô∏Îê† Ïàò ÏûàÏäµÎãàÎã§.</p>
                          </div>
                           <!-- Place.recommendPlaceIdÎ•º activePlaceIdÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Ï†ÑÎã¨ -->
                          <CreateModalPlace
                              v-if="replyModalCreate"
                              :replyModalCreate="replyModalCreate"
                              :recommendPlaceId="activePlaceId" 
                              :type="currentType"
                              @close="closeModal" />
                        </div><!-- cont-reply -->
                    </div><!-- cont-sub -->
                  </div><!-- div_profile -->

                  </div>
              <div id="subright-cont">
                  <div class="mini-map">
                    <div v-for="(place, i) in recommendListDetailPlace" :key="i" >
                        <!-- Í∏∞ÌÉÄ Ïª®ÌÖêÏ∏† -->
                        <KakaoMap :latitude="place.recommendPlaceLatitude" :longitude="place.recommendPlaceLongitude" 
                        :placeTitle="place.recommendPlaceTitle" />
                    </div>
                  </div>
                  <!-- recommendListplaceRegion ÌëúÏãú -->
                  <div class="recommend-list">
                      <h6 style="text-align: left;">
                        <span>{{ place.recommendPlaceRegion }}</span>
                        Ï£ºÎ≥Ä
                        <span>{{ place.recommendPlaceCategory }}</span>
                      </h6>
                      <div>
                      <ul>
                        <li v-for="(place, index) in recommendListPlaceRegion" :key="index" >
                          <div @click="goToDetail(place.recommendPlaceId)" class="recommend-info">
                            <div class="recommend-name-region">
                              <p class="recommend-name">{{ place.recommendPlaceTitle }}</p>
                              <p class="recommend-region"><span><font-awesome-icon :icon="['fas', 'location-dot']" /></span>{{ place.recommendPlaceRegion }}</p>
                            </div>
                            <div class="recommend-details">
                              <p class="recommend-tag">{{ place.recommendPlaceTag }}</p>
                              <div>
                                <img class="recommend-photo" :src="place.recommendPlaceImgPath || 'default-image-url'" alt="Í¥ÄÍ¥ëÏßÄ ÏÇ¨ÏßÑ">
                              </div>
                            </div>
                          </div> <!-- goToDetail recommend-info -->
                        </li> <!-- v-for -->
                      </ul>
                      </div>
                  </div> <!-- recommend-list -->
              </div>
            </div>
          </div>

      </div>
  </div>
</template>

<script>
import KakaoMap from "@/components/KakaoMap/KakaoMap.vue";
import CreateModalPlace from './CreateModalPlace.vue';
import PlaceChart from './PlaceChart.vue';

export default {
name: 'RecommendListDetailPlace',
data() {
  return {
    recommendListDetailPlace: [],
    replyModalCreate: false,
    activePlaceId: null,  // ÌôúÏÑ±ÌôîÎêú ÏùåÏãù ID Ï†ÄÏû•, Î™®Îã¨ Ï†ÑÎã¨
    currentType: 'place',
    placeRegion: '', //Ï£ºÎ≥Ä ÏßÄÏó≠ Ï†ïÎ≥¥
    placeLatitude: 0,
    placeLongitude: 0,
    recommendListPlaceRegion: [],
    replyPlaceStar: '', //Í¥ÄÍ¥ëÏßÄ ÌèâÏ†ê Ï†ïÎ≥¥
    recommendReplyStar: '',
    placeTitle:'',
    //replyPlaceTags: ''
  };
},
components: {
  KakaoMap,
  CreateModalPlace,
  PlaceChart
},
props: {
  recommendPlaceId: {  // Ïô∏Î∂ÄÏóêÏÑú Ï†ÑÎã¨Î∞õÎäî ID prop
    type: Number,
    required: true
  }
},
methods: {
  async fetchPlaceDetails() {
      if (!this.recommendPlaceId) {
          console.error("recommendPlaceIdÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!");
          return;
      }
      try {
          let response = await this.$axios.get(`/api/recommend/listplace/${this.recommendPlaceId}`);
          if (response.data) {
              const data = response.data;
              // Îç∞Ïù¥ÌÑ∞ Í∞ÄÍ≥µ
              data.recommendPlaceTag = data.recommendPlaceTag ? data.recommendPlaceTag.split(',').slice(0, 8).join(', ') : '';
              data.recommendPlaceAllTag = data.recommendPlaceAllTag ? data.recommendPlaceAllTag.split(',').slice(0, 16).join(', ') : '';
              this.recommendListDetailPlace = [data];
              this.placeRegion = data.recommendPlaceRegion;
              this.placeLatitude = data.recommendPlaceLatitude;
              this.placeLongitude = data.recommendPlaceLongitude;
              this.placeTitle = data.recommendPlaceTitle;
              this.replyModalCreate = false;
              this.fetchRegionData(); // fetchRegionData Ìò∏Ï∂ú
              this.fetchRatingData(); //fetchRatingData Ìò∏Ï∂ú 
              // this.fetchReplyTags();
          }
          console.log("Î°úÎî© Îêú ÏßÄÏó≠ Ï†ïÎ≥¥:", this.placeRegion);
          console.log("Î°úÎî© Îêú ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥:", this.recommendListDetailPlace);
      } catch (error) {
          console.error('Í¥ÄÍ¥ëÏßÄ ÏÑ∏Î∂Ä Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë ÏóêÎü¨ Î∞úÏÉù:', error);
      }
  }, //fetchPlaceDetails
  async fetchRegionData() {
  try {
    const params = {
      page: 0,
      size: 3, // ÏµúÎåÄ 3Í∞úÏùò Ìï≠Î™©Îßå Í∞ÄÏ†∏Ïò¥
      sort: "recommendPlaceRegion,desc",
      region: this.placeRegion
    };
    const response = await this.$axios.get("/api/recommend/listplace", { params });
    if (response.data.content.length === 0) {
      console.error('No data returned for the page:', this.currentPage);
      this.recommendListPlaceRegion = [];
      this.totalPages = 0;
    } else {
      // ÏµúÎåÄ 3Í∞úÏùò Ìï≠Î™©Îßå Ï∂îÏ∂úÌïòÏó¨ Ï†ÄÏû•
      this.recommendListPlaceRegion = response.data.content.slice(0, 3).map(item => {
        // recommendPlaceTagÎ•º ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå Ï∂îÏ∂ú
        const tags = item.recommendPlaceTag ? item.recommendPlaceTag.split(',').slice(0, 2).join(', ') : '';
        return { ...item, recommendPlaceTag: tags };
      });
      console.log("Î°úÎî©Îêú ÏßÄÏó≠ Ï†ïÎ≥¥:", this.recommendListPlaceRegion);
    }
  } catch (error) {
    console.error("ÏóêÎü¨ Î∞úÏÉù:", error);
  }
}, //fetchRegionData
  async fetchRatingData() {
      console.log("fetchRatingData() Î©îÏÑúÎìúÍ∞Ä Ìò∏Ï∂úÎêòÏóàÏäµÎãàÎã§.");
      try {
        // API URL ÏàòÏ†ï: ÎèôÏ†Å IDÎ•º Í≤ΩÎ°úÏóê Ìè¨Ìï®
        const response = await this.$axios.get(`/api/recommendreply/place/average/star/${this.recommendPlaceId}`);
        if (!response.data || response.data === "ÌèâÏ†êÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÏñ¥Ïöî") {
          this.replyPlaceStar = response.data; // API ÏùëÎãµÏù¥ ÌèâÏ†ê Î¨∏ÏûêÏó¥ ÎòêÎäî ÌèâÍ∑† ÌèâÏ†ê ÏóÜÏùå Î©îÏãúÏßÄ
        } else {
          // ÏÜåÏàòÏ†êÏùÑ Ï†úÍ±∞ÌïòÍ≥† Î∞òÏò¨Î¶º
          this.replyPlaceStar = Math.round(response.data);
        }
        console.log("ÌèâÍ∑† ÌèâÏ†ê:", this.replyPlaceStar);
      } catch (error) {
        console.error("ÌèâÍ∑† ÌèâÏ†ê Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:", error);
        this.replyPlaceStar = "ÌèâÏ†ê Ï†ïÎ≥¥ ÏóÜÏùå";
      }
  }, //fetchRatingData

  isOperating(closeTime) {  //ÏòÅÏóÖÏ§ë, ÏòÅÏóÖÎßàÍ∞ê
    if (!closeTime) return 'Ìú¥Î¨¥Ïùº'; // Ìú¥Î¨¥Ïùº Ï≤òÎ¶¨
    
    const now = new Date();
    const currentHours = now.getHours();
    const currentMinutes = now.getMinutes();
    const [closeHours, closeMinutes] = closeTime.split(':').map(Number);

    if (currentHours < closeHours || (currentHours === closeHours && currentMinutes < closeMinutes)) {
      return 'ÏòÅÏóÖÏ§ë';
    } else {
      return 'ÏòÅÏóÖÎßàÍ∞ê';
    }
  }, //isOperating
  createModal(recommendPlaceId) {
    // Î™®Îã¨ÏùÑ ÏÉùÏÑ±ÌïòÎäî Î°úÏßÅ
    console.log("createModalPlace ÏÉùÏÑ±");
    //console.log("Î™®Îã¨ ÏÉùÏÑ±, ID:", recommendPlaceId); // Î°úÍ∑∏ Ï∂îÍ∞ÄÌïòÏó¨ ID ÌôïÏù∏
    // activePlaceId ÏÑ§Ï†ïÏúºÎ°ú Î™®Îã¨Ïóê ID Ï†ÑÎã¨
    this.activePlaceId = recommendPlaceId; // Î™®Îã¨ ÏÉùÏÑ± ID
    console.log("Î™®Îã¨Ïóê Ï†ÑÎã¨Îê† ID:", this.activePlaceId);  // Î™®Îã¨Ïóê Ï†ÑÎã¨Îê† IDÍ∞Ä Ïò¨Î∞îÎ•¥Í≤å ÏÑ§Ï†ïÎêòÏóàÎäîÏßÄ ÌôïÏù∏
    this.replyModalCreate = true;
    console.log("createModalPlace ÏÉùÏÑ±:", this.replyModalCreate);
  }, //createModal
  closeModal() {
    // Î™®Îã¨ÏùÑ Îã´Îäî Î°úÏßÅ
    console.log("createModal Îã´Í∏∞");
    this.replyModalCreate = false;
    this.activePlaceId = null;  // Î™®Îã¨ Îã´ÏùÑ Îïå ID Ï¥àÍ∏∞Ìôî
  },
  getStatusClass(closeTime) {
    const status = this.isOperating(closeTime);
    return {
      'card-opentime': status === 'ÏòÅÏóÖÏ§ë',  // 'ÏòÅÏóÖÏ§ë'Ïóê Ìï¥ÎãπÌïòÎäî CSS ÌÅ¥ÎûòÏä§
      'card-closetime': status === 'ÏòÅÏóÖÎßàÍ∞ê' // 'ÏòÅÏóÖÎßàÍ∞ê'Ïóê Ìï¥ÎãπÌïòÎäî CSS ÌÅ¥ÎûòÏä§
    };
  }, //getStatusClass
  getStatusMessage(closeTime) {
    return this.isOperating(closeTime);
  }, //getStatusMessage
  goToDetail(recommendPlaceId) {
    if (!recommendPlaceId) {
      console.error("Error: recommendPlaceId Ï∞æÏùÑ Ïàò ÏóÜÏùå");
      return;
    }
    console.log("Ïù¥Îèô Ìï† recommendPlaceId:", recommendPlaceId);
    this.$router.push({ name: 'detailplace', params: { recommendPlaceId } }).catch(err => {
    console.error(err);
    });  //recommendPlaceId ÌéòÏù¥ÏßÄ Ïù¥Îèô
  }, //goToDetail
  refreshPage() {
    // ÌéòÏù¥ÏßÄ ÏÉàÎ°ú Í≥†Ïπ®
    window.location.reload();
  }, //refreshPage
  parseTags(tagsString) {
    //ÌÉúÍ∑∏ Î≤ÑÌäº ÎîîÏûêÏù∏ Ï†ÅÏö©
    return tagsString.split(',').map(tag => tag.trim());
  },
  },
  mounted() {
    this.fetchPlaceDetails();
    // ÌéòÏù¥ÏßÄ ÏÉàÎ°ú Í≥†Ïπ® Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    this.$router.afterEach(() => {
    this.refreshPage();
    });
  },
  compute: { //Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Î∞îÌÉïÏúºÎ°ú ÏÉàÎ°úÏö¥ Îç∞Ïù¥ÌÑ∞ Í∞íÏùÑ ÏÉùÏÑ±Ìï† Îïå
  }
}
</script>

<style scoped>
@import "@/assets/css/recommendDetail_style.css";

</style>